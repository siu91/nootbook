#  Postgres 数据库规约（试行）

| 序号 | 版本 | 版本日期   | 编辑人 | 复核人                                 | 修订内容             |
| ---- | ---- | ---------- | ------ | -------------------------------------- | -------------------- |
| 1    | V1.0 | 2020-06-04 | 龚世文 | 廖春水、邓日锦                         | 命名、建表等（初稿） |
| 2    | V1.1 | 2020-07-17 | 龚世文 | 叶新艳、冯海雄、廖春水、齐善锋、陈文洲 |                      |

 

## 一 命名

- **1.1【强制】**表名、字段名等必须使用小写字母或数字或”_“(下划线)，禁止出现数字开头，禁止两个下划线中间只出现数字。

  说明： Windows 下不区分大小写，但在 Linux 下默认是区分大小写。因此，**数据库名、模式名、表名、视图、函数、存储过程、字段名、用户名、角色名、sql文件命名**，都不允许出现任何大写字母，避免节外生枝。

  正例：aliyun_admin，rdc_config，level3_name

  反例：AliyunAdmin，rdcConfig，level_3_name

- **1.2【强制】**命名禁用保留字，如 desc、group、limit等，请参考 **[附录1](#附录)**。

- **1.3【强制】**严禁使用拼音与英文混合命名，更不允许直接使用中文拼音命名。

  正例：huawei/alibaba/taobao/weixin/baidu，国际通用的名称，可视同英文。

  反例：caiji_sys（采集系统）,dashuju_platform（大数据平台）。

- **1.4【强制】**主键索引名为 `pk_表名_字段名`；唯一索引名为 `uk_字段名`；普通索引名则为 `idx_字段名`。

  说明：pk_ 即 primary key；uk_ 即 unique key；idx_ 即 index 的简称。




## 二 建库&模式

- **2.1【强制】**库名格式 ：cecdat_[产品标识]

- **2.2【强制】**模式名称：业务名（应用名）

  

## 三 建表

- **3.1【强制】**表达是与否概念的字段，必须使用 is_xxx 的方式命名

  说明：Postgres，数据类型是 int2（1 表示是，0 表示否）。

  正例：表达逻辑删除的字段名 is_deleted，1 表示删除，0 表示未删除。

- **3.2【强制】**表名不使用复数名词。

  说明：表名应该仅仅表示表里面的实体内容，不应该表示实体数量，对应于 DO 类名也是单数形式，符合表达习惯。

- **3.3【强制】**小数类型为 decimal，禁止使用 float 和 double。(金额强制)

  说明：在存储的时候，float 和 double 都存在精度损失的问题，很可能在比较值的时候，得到不正确的结果。如果存储的数据范围超过 decimal 的范围，建议将数据拆成整数和小数并分开存储。

- **3.4【强制】**如果存储的字符串长度几乎相等，使用 char 定长字符串类型。

- **3.5【强制】**varchar 是可变长字符串，不预先分配存储空间，长度不要超过 5000，如果存储长度大于此值，定义字段类型为 text，独立出来一张表，用主键来对应，避免影响其它字段索引效率。

- **3.6【强制】**表必备三字段：id, create_time, update_time。

  说明：

  - id 必为主键，类型为**serial8**自增序列
  - 默认选择8字节长度存储，步长为 1；具体情况参考**[3.12规约]()、[附录2]()**
  - 非特殊情况下不需要主动创建序列
  - 日志表可以没有`update_time`
  - id 非自增要注明足够的理由。
  - create_time, update_time 的类型均为 timestamp 类型（without time zone）

- **3.7**【强制】表、字段必须有注释，特别是枚举值，需要注释字典含义。

- **3.8**【推荐】表的命名最好是遵循“业务名称_表的作用”。

  正例：dc_task、bdp_config

- **3.9**【推荐】如果修改字段含义或对字段表示的状态追加时，需要及时更新字段注释。

- **3.10**【推荐】字段允许适当冗余，以提高查询性能，但必须考虑数据一致。冗余字段应遵循：
  
  - 不是频繁修改的字段
  - 不是唯一索引的字段。
- 不是 varchar 超长字段，更不能是 text 字段。
  
- **3.11**【推荐】单表行数超过 500 万行或者单表容量超过 2GB，才推荐进行分库分表。

  说明：如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表。

- **3.12**【参考】合适的字符存储长度，不但节约数据库表空间、节约索引存储，更重要的是提升检索速度。

  正例：

  | 对象 | 年龄区间    | 类型     | 字节 | 表示范围                                     |
  | ---- | ----------- | -------- | ---- | -------------------------------------------- |
  | 人   | 0-200       | smallint | 2    | -32768 到 +32767                             |
  | 龟   | 0-几百      | smallint | 2    | -32768 到 +32767                             |
  | 化石 | 数千万      | integer  | 4    | -2147483648 到 +2147483647                   |
  | 太阳 | 几十亿-百亿 | bigint   | 8    | -9223372036854775808 到 +9223372036854775807 |





## 四 其他

其它数据库开发优化建议参考《Java 开发手册》（Alibaba）。



# 附录

[附录1-SQL 标准和PostgreSQL 10.1 中的关键词](http://www.postgres.cn/docs/10/sql-keywords-appendix.html)

[附录2-PostgreSQL数字类型](http://www.postgres.cn/docs/10/datatype-numeric.html#DATATYPE-INT)

| 名字               | 存储尺寸 | 描述               | 范围                                         |
| ------------------ | -------- | ------------------ | -------------------------------------------- |
| `smallint`         | 2字节    | 小范围整数         | -32768 to +32767                             |
| `integer`          | 4字节    | 整数的典型选择     | -2147483648 to +2147483647                   |
| `bigint`           | 8字节    | 大范围整数         | -9223372036854775808 to +9223372036854775807 |
| `decimal`          | 可变     | 用户指定精度，精确 | 最高小数点前131072位，以及小数点后16383位    |
| `numeric`          | 可变     | 用户指定精度，精确 | 最高小数点前131072位，以及小数点后16383位    |
| `real`             | 4字节    | 可变精度，不精确   | 6位十进制精度                                |
| `double precision` | 8字节    | 可变精度，不精确   | 15位十进制精度                               |
| `smallserial`      | 2字节    | 自动增加的小整数   | 1到32767                                     |
| `serial`           | 4字节    | 自动增加的整数     | 1到2147483647                                |
| `bigserial`        | 8字节    | 自动增长的大整数   | 1到9223372036854775807                       |

[附录3-PostgreSQL 10.1 手册](http://www.postgres.cn/docs/10/)





**本页编辑**      **[@gongshiwen](http://192.168.1.23/gongshiwen)** <img src="http://192.168.1.23/uploads/-/system/user/avatar/10/avatar.png?width=100" style="zoom:10%;" />